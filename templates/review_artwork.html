{% extends "main.html" %}
{% block title %}Review Artwork | CapitalArt{% endblock %}
{% block content %}

<!-- ======================= [RA.1] Review Artwork Grid Layout ======================= -->
<div class="review-artwork-grid">
  <!-- === [RA.1.1] LEFT COLUMN: MOCKUP PREVIEWS + CONTROLS === -->
  <div class="mockup-col">
    <div class="main-thumb">
      <a href="{{ url_for('processed_image', seo_folder=artwork.seo_name, filename=artwork.main_image.split('/')[-1]) }}" target="_blank">
        <img src="{{ url_for('processed_image', seo_folder=artwork.seo_name, filename=artwork.thumb.split('/')[-1]) }}"
          alt="{{ artwork.title }} thumbnail"
          class="main-thumbnail-img">
      </a>
      <div class="thumb-note">Click thumbnail for full size</div>
    </div>
    <div>
      <h3>Preview Mockups</h3>
      <div class="mockup-preview-grid">
        {% for mockup in mockup_previews %}
        <div class="mockup-card">
          <!-- [RA.1.1.1] Modal Preview Link -->
          <a href="{{ url_for('processed_image', seo_folder=artwork.seo_name, filename=mockup.filename) }}"
             class="mockup-img-link"
             data-img="{{ url_for('processed_image', seo_folder=artwork.seo_name, filename=mockup.filename) }}"
             data-mockup="{{ mockup.index }}">
            <img
              src="{{ url_for('processed_image', seo_folder=artwork.seo_name, filename=mockup.filename) }}"
              alt="Mockup #{{ mockup.index+1 }}"
              class="mockup-thumb-img">
          </a>
          <div class="mockup-number">Mockup #{{ loop.index }}</div>
          <!-- [RA.1.1.2] Swap Category Form -->
          <form method="POST" action="{{ url_for('swap_composite', seo_folder=artwork.seo_name, slot_index=mockup.index) }}">
            <select name="new_category">
              {% for cat in categories %}
                <option value="{{ cat }}" {% if mockup.category == cat %}selected{% endif %}>{{ cat }}</option>
              {% endfor %}
            </select>
            <button type="submit" class="btn btn-sm">üîÅ Swap</button>
          </form>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- === [RA.1.2] RIGHT COLUMN: COMBINED DESCRIPTION + INFO === -->
  <div class="desc-col">
    <h1>{{ artwork.title }}</h1>
    <div class="desc-panel">
      <h2>üìù Etsy Listing Description (Combined)</h2>
      <div class="desc-text"
           style="white-space: pre-wrap; background: #fafbfc; border-radius: 8px; box-shadow: 0 1px 4px #0001; padding: 16px; min-height: 110px; max-height: 350px; overflow-y: auto; font-size: 1.05em; margin-bottom: 1em;">
        {{ combined_description }}
      </div>
      {% if tags %}
        <div class="desc-tags"
             style="margin-top: 8px; margin-bottom: 6px; font-size: 1em; background: #f7f7f9; border-radius: 6px; padding: 7px 13px;">
          <strong>Tags:</strong> {{ tags|join(', ') }}
        </div>
      {% endif %}
      {% if materials %}
        <div class="desc-materials"
             style="margin-bottom: 8px; font-size: 1em; background: #f9f7f7; border-radius: 6px; padding: 7px 13px;">
          <strong>Materials:</strong> {{ materials|join(', ') }}
        </div>
      {% endif %}
      {% if used_fallback_naming %}
        <div class="fallback-warning" style="margin-top:7px;">‚ö†Ô∏è SEO Filename used fallback extraction.</div>
      {% endif %}
    </div>
    <div class="colour-info-grid">
      <div>
        <div class="label">Primary Colour</div>
        <div class="colour-box">{{ artwork.primary_colour if artwork.primary_colour else "&mdash;" }}</div>
      </div>
      <div>
        <div class="label">Secondary Colour</div>
        <div class="colour-box">{{ artwork.secondary_colour if artwork.secondary_colour else "&mdash;" }}</div>
      </div>
    </div>
    <form method="POST" action="{{ url_for('analyze_artwork', aspect=artwork.aspect, filename=artwork.seo_name + '.jpg') }}">
      <div class="reanalyse-label">Re-analyse Artwork</div>
      <textarea name="feedback" placeholder="Add feedback or changes for next analysis..." rows="3"></textarea>
      <br>
      <button type="submit" class="btn btn-primary">Re-analyse</button>
    </form>
    <div class="back-link">
      <a href="{{ url_for('artworks') }}">&larr; Back to Artwork Gallery</a>
    </div>
  </div>
</div>

<!-- ======================= [RA.2] Mockup Fullscreen Modal ======================= -->
<div id="mockup-modal-bg" class="modal-bg" style="display:none;">
  <button id="mockup-modal-close" class="modal-close" aria-label="Close modal">&times;</button>
  <div class="modal-img">
    <img id="mockup-modal-img" src="" alt="Full-size Mockup Preview" />
  </div>
</div>

<!-- ======================= [RA.3] Modal JS ======================= -->
<script>
  document.querySelectorAll('.mockup-img-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const modal = document.getElementById('mockup-modal-bg');
      const modalImg = document.getElementById('mockup-modal-img');
      modalImg.src = this.dataset.img;
      modal.style.display = 'flex';
    });
  });
  document.getElementById('mockup-modal-close').onclick = function() {
    document.getElementById('mockup-modal-bg').style.display = 'none';
    document.getElementById('mockup-modal-img').src = '';
  };
  document.getElementById('mockup-modal-bg').onclick = function(e) {
    if (e.target === this) {
      this.style.display = 'none';
      document.getElementById('mockup-modal-img').src = '';
    }
  }
</script>
{% endblock %}
